<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rumo ao Topo - Gestão de Estudos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A192F; /* Azul escuro principal */
            color: #E6F1FF;
        }
        .main-bg { background-color: #0A192F; }
        .primary-bg { background-color: #172A45; }
        .accent-bg { background-color: #FF8C00; } /* Amarelo alaranjado */
        .accent-text { color: #FF8C00; }
        .accent-border { border-color: #FF8C00; }
        .secondary-text { color: #8892B0; }
        .card { background-color: #172A45; border-radius: 8px; border: 1px solid #233554; }
        .btn {
            background-color: #FF8C00;
            color: #0A192F;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(255, 140, 0, 0.2);
        }
        .btn-secondary {
             background-color: #233554;
             color: #E6F1FF;
        }
        .btn-secondary:hover {
            background-color: #304a75;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .input-field, .select-field {
            background-color: #0A192F;
            border: 1px solid #233554;
            color: #E6F1FF;
            border-radius: 6px;
            padding: 10px;
            width: 100%;
        }
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: #FF8C00;
            box-shadow: 0 0 0 2px rgba(255, 140, 0, 0.3);
        }
        [v-cloak] { display: none; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .table-input {
            background-color: #233554;
            border: 1px solid #304a75;
            color: #E6F1FF;
            border-radius: 4px;
            padding: 6px 8px;
            width: 70px;
            text-align: center;
        }
        .table-input:focus {
            background-color: #0A192F;
            border-color: #FF8C00;
            outline: none;
        }
    </style>
</head>
<body class="main-bg antialiased">

    <div id="app" v-cloak>
        <!-- Notificação Global -->
        <div v-if="notification.message" :class="notification.type === 'success' ? 'bg-green-500' : 'bg-red-500'" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-all duration-300">
            <i :class="notification.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
            {{ notification.message }}
        </div>
        
        <!-- Tela de Login -->
        <div id="login-view" v-if="currentView === 'login'" class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md card p-8 space-y-6">
                <div class="text-center">
                    <h1 class="text-3xl font-bold accent-text">Rumo ao Topo</h1>
                    <p class="secondary-text mt-2">Plataforma de Gestão de Estudos</p>
                </div>
                <form @submit.prevent="login" class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium secondary-text">Email</label>
                        <input type="email" v-model="loginForm.email" id="email" class="input-field mt-1" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium secondary-text">Senha</label>
                        <input type="password" v-model="loginForm.password" id="password" class="input-field mt-1" required>
                    </div>
                    <button type="submit" class="btn w-full">
                        <i class="fas fa-sign-in-alt mr-2"></i> Entrar
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Carregando... -->
        <div v-if="currentView === 'loading'" class="min-h-screen flex items-center justify-center">
             <i class="fas fa-spinner fa-spin text-4xl accent-text"></i>
        </div>

        <!-- Portal Principal (Admin ou Aluno) -->
        <div id="main-portal" v-if="currentView === 'admin' || currentView === 'student'" class="min-h-screen md:flex">
            <!-- Sidebar -->
            <aside class="w-full md:w-64 primary-bg p-4 md:p-6 flex-shrink-0 md:flex md:flex-col">
                <div class="text-center mb-8">
                    <h1 class="text-2xl font-bold accent-text">Rumo ao Topo</h1>
                    <p class="secondary-text text-sm">{{ user.isAdmin ? 'Portal do Administrador' : 'Portal do Aluno' }}</p>
                </div>
                <nav class="space-y-2 flex-grow">
                    <!-- Menu Admin -->
                    <template v-if="user.isAdmin">
                        <a href="#" @click.prevent="activeTab = 'dashboard'" :class="{'accent-bg text-gray-900 font-bold': activeTab === 'dashboard', 'hover:bg-blue-900/50': activeTab !== 'dashboard'}" class="flex items-center p-3 rounded-lg transition-colors">
                            <i class="fas fa-tachometer-alt w-6 text-center"></i><span class="ml-3">Dashboard</span>
                        </a>
                        <a href="#" @click.prevent="activeTab = 'members'" :class="{'accent-bg text-gray-900 font-bold': activeTab === 'members', 'hover:bg-blue-900/50': activeTab !== 'members'}" class="flex items-center p-3 rounded-lg transition-colors">
                            <i class="fas fa-users w-6 text-center"></i><span class="ml-3">Membros</span>
                        </a>
                        <a href="#" @click.prevent="activeTab = 'grades'" :class="{'accent-bg text-gray-900 font-bold': activeTab === 'grades', 'hover:bg-blue-900/50': activeTab !== 'grades'}" class="flex items-center p-3 rounded-lg transition-colors">
                           <i class="fas fa-graduation-cap w-6 text-center"></i><span class="ml-3">Lançar Notas</span>
                        </a>
                    </template>
                </nav>
                <div class="mt-auto pt-8">
                     <div class="text-center secondary-text text-sm mb-4">
                        <p>Logado como:</p>
                        <p class="font-semibold text-white truncate">{{ user.email }}</p>
                    </div>
                    <button @click="logout" class="btn btn-secondary w-full">
                        <i class="fas fa-sign-out-alt mr-2"></i> Sair
                    </button>
                </div>
            </aside>

            <!-- Conteúdo Principal -->
            <main class="flex-1 p-6 md:p-10 main-bg overflow-y-auto">
                <h1 class="text-3xl font-bold mb-6 text-white">Olá, {{ user.email.split('@')[0] }}!</h1>
                
                <div v-if="activeTab === 'dashboard'">
                     <h2 class="text-2xl font-bold accent-text mb-4">Dashboard</h2>
                     <p class="secondary-text">Visão geral do sistema. Funcionalidades futuras aparecerão aqui.</p>
                </div>
                
                 <!-- Aba de Membros (Admin) -->
                <div v-if="user.isAdmin && activeTab === 'members'">
                   <h2 class="text-2xl font-bold accent-text mb-4">Gerenciamento de Membros</h2>
                   <div class="card p-6">
                        <button @click="showAddMemberModal = true" class="btn mb-4">
                            <i class="fas fa-user-plus mr-2"></i> Adicionar Membro
                        </button>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="border-b border-gray-700">
                                    <tr>
                                        <th class="p-3">Email</th>
                                        <th class="p-3">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="member in members" :key="member.uid" class="border-b border-gray-800 hover:bg-gray-800/50">
                                        <td class="p-3">{{ member.email }}</td>
                                        <td class="p-3 space-x-2">
                                            <button @click="prepareEditMember(member)" class="text-blue-400 hover:text-blue-300" title="Editar"><i class="fas fa-edit"></i></button>
                                            <button @click="prepareRemoveMember(member)" class="text-red-500 hover:text-red-400" title="Remover"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                   </div>
                </div>

                <!-- Aba de Lançar Notas (Admin) -->
                <div v-if="user.isAdmin && activeTab === 'grades'">
                    <h2 class="text-2xl font-bold accent-text mb-4">Lançamento de Notas</h2>
                    <div class="card p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                             <div>
                                <label for="bimestre" class="block text-sm font-medium secondary-text">Selecione o Bimestre</label>
                                <select v-model="grades.selectedBimestre" id="bimestre" class="select-field mt-1">
                                    <option disabled value="">Escolha um bimestre</option>
                                    <option v-for="b in bimestres" :key="b" :value="b">{{ b }}º Bimestre</option>
                                </select>
                            </div>
                            <div>
                                <label for="materia" class="block text-sm font-medium secondary-text">Selecione a Matéria</label>
                                <select v-model="grades.selectedMateria" id="materia" class="select-field mt-1">
                                    <option disabled value="">Escolha uma matéria</option>
                                    <option v-for="m in materias" :key="m" :value="m">{{ m }}</option>
                                </select>
                            </div>
                        </div>

                        <div v-if="grades.isLoading" class="text-center p-8">
                             <i class="fas fa-spinner fa-spin text-2xl accent-text"></i>
                             <p class="secondary-text mt-2">Carregando notas...</p>
                        </div>
                        
                        <div v-else-if="grades.selectedBimestre && grades.selectedMateria" class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="border-b border-gray-700">
                                    <tr>
                                        <th class="p-3">Aluno</th>
                                        <th class="p-3 text-center">L1</th>
                                        <th class="p-3 text-center">L2</th>
                                        <th class="p-3 text-center">L3</th>
                                        <th class="p-3 text-center">L4</th>
                                        <th class="p-3 text-center font-bold accent-text">MÉDIA</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="member in members" :key="member.uid" class="border-b border-gray-800 hover:bg-gray-800/50">
                                        <td class="p-3">{{ member.email }}</td>
                                        <td class="p-3 text-center"><input type="number" step="0.1" min="0" max="10" class="table-input" v-model.number="grades.sheet[member.uid].l1"></td>
                                        <td class="p-3 text-center"><input type="number" step="0.1" min="0" max="10" class="table-input" v-model.number="grades.sheet[member.uid].l2"></td>
                                        <td class="p-3 text-center"><input type="number" step="0.1" min="0" max="10" class="table-input" v-model.number="grades.sheet[member.uid].l3"></td>
                                        <td class="p-3 text-center"><input type="number" step="0.1" min="0" max="10" class="table-input" v-model.number="grades.sheet[member.uid].l4"></td>
                                        <td class="p-3 text-center font-bold" :class="calculateAverage(member.uid) < 6 ? 'text-red-400' : 'text-green-400'">
                                            {{ calculateAverage(member.uid) }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="mt-6 text-right">
                                <button @click="saveGrades" class="btn">
                                    <i class="fas fa-save mr-2"></i> Salvar Notas
                                </button>
                            </div>
                        </div>

                        <div v-else class="text-center p-8 border-2 border-dashed border-gray-700 rounded-lg">
                            <p class="secondary-text">Por favor, selecione um bimestre e uma matéria para começar a lançar as notas.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal Adicionar/Editar Membro -->
        <div v-if="showAddMemberModal || showEditMemberModal" class="modal-overlay">
            <div class="card w-full max-w-lg p-6">
                <h3 class="text-xl font-bold mb-4 accent-text">{{ isEditingMember ? 'Editar Membro' : 'Adicionar Novo Membro' }}</h3>
                <form @submit.prevent="isEditingMember ? updateMember() : addMember()">
                    <div class="mb-4">
                        <label for="memberEmail" class="block text-sm font-medium secondary-text">Email do Aluno</label>
                        <input type="email" v-model="memberForm.email" id="memberEmail" class="input-field mt-1" required>
                    </div>
                    <div class="mb-6">
                        <label for="memberPassword" class="block text-sm font-medium secondary-text">Senha</label>
                        <input type="password" v-model="memberForm.password" id="memberPassword" class="input-field mt-1" :placeholder="isEditingMember ? 'Deixe em branco para não alterar' : ''" :required="!isEditingMember">
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" @click="closeMemberModal" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Modal de Confirmação de Remoção -->
        <div v-if="showRemoveMemberModal" class="modal-overlay">
            <div class="card w-full max-w-md p-6 text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                <h3 class="text-xl font-bold mb-2">Confirmar Remoção</h3>
                <p class="secondary-text mb-6">Você tem certeza que deseja remover o membro <strong class="text-white">{{ memberToRemove.email }}</strong>? Esta ação não pode ser desfeita.</p>
                <div class="flex justify-center gap-4">
                    <button @click="showRemoveMemberModal = false" class="btn btn-secondary">Cancelar</button>
                    <button @click="removeMember" class="btn bg-red-600 hover:bg-red-700 text-white">Remover</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, setDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // *********************************************************************************
        // ATENÇÃO: Cole aqui a configuração do seu projeto Firebase
        // *********************************************************************************
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_STORAGE_BUCKET",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };
        // *********************************************************************************

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN_EMAIL = "henriquefnci@gmail.com";

        const { createApp } = Vue

        createApp({
            data() {
                return {
                    currentView: 'loading',
                    activeTab: 'dashboard',
                    user: { isLoggedIn: false, isAdmin: false, email: null, uid: null },
                    loginForm: { email: '', password: '' },
                    notification: { message: '', type: 'success' },
                    members: [],
                    showAddMemberModal: false,
                    showEditMemberModal: false,
                    showRemoveMemberModal: false,
                    isEditingMember: false,
                    memberForm: { email: '', password: '', uid: null },
                    memberToRemove: null,
                    // Dados para Notas
                    bimestres: [1, 2, 3, 4],
                    materias: ['Português', 'Artes', 'Literatura', 'Redação', 'Matemática', 'Complementos', 'História', 'Geografia', 'Filosofia', 'Física', 'Química', 'Biologia'],
                    grades: {
                        selectedBimestre: '',
                        selectedMateria: '',
                        sheet: {}, // { 'uidAluno': { l1: 10, l2: 8, ... } }
                        isLoading: false,
                    }
                }
            },
            watch: {
                'grades.selectedBimestre'(newVal, oldVal) {
                    if (newVal && this.grades.selectedMateria) this.fetchGrades();
                },
                'grades.selectedMateria'(newVal, oldVal) {
                    if (newVal && this.grades.selectedBimestre) this.fetchGrades();
                }
            },
            mounted() {
                this.checkAuthState();
            },
            methods: {
                showNotification(message, type = 'success', duration = 3000) {
                    this.notification.message = message;
                    this.notification.type = type;
                    setTimeout(() => { this.notification.message = ''; }, duration);
                },
                checkAuthState() {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            this.user.isLoggedIn = true;
                            this.user.email = user.email;
                            this.user.uid = user.uid;
                            this.user.isAdmin = (user.email === ADMIN_EMAIL);
                            if (this.user.isAdmin) {
                                this.currentView = 'admin';
                                await this.fetchMembers();
                            } else {
                                this.currentView = 'student';
                            }
                        } else {
                            Object.assign(this.user, { isLoggedIn: false, isAdmin: false, email: null, uid: null });
                            this.currentView = 'login';
                        }
                    });
                },
                async login() {
                    if(this.loginForm.email === ADMIN_EMAIL && this.loginForm.password === "Henrique@4") {
                        try {
                            await signInWithEmailAndPassword(auth, this.loginForm.email, this.loginForm.password);
                        } catch (error) {
                            if (error.code === 'auth/user-not-found') {
                                try {
                                    await createUserWithEmailAndPassword(auth, this.loginForm.email, this.loginForm.password);
                                } catch (creationError) {
                                    this.showNotification(`Erro ao criar admin: ${creationError.message}`, 'error'); return;
                                }
                            } else {
                                 this.showNotification(`Erro no login: ${error.message}`, 'error'); return;
                            }
                        }
                    } else {
                         try {
                            await signInWithEmailAndPassword(auth, this.loginForm.email, this.loginForm.password);
                        } catch (error) {
                            this.showNotification(`Erro no login: ${error.message}`, 'error'); return;
                        }
                    }
                    this.loginForm = { email: '', password: '' };
                },
                async logout() {
                    await signOut(auth);
                },
                // === MÉTODOS DE ADMIN - MEMBROS ===
                async fetchMembers() {
                    if (!this.user.isAdmin) return;
                    this.members = [];
                    try {
                        const usersCollection = collection(db, "users");
                        const q = query(usersCollection, where("role", "==", "student"));
                        const querySnapshot = await getDocs(q);
                        querySnapshot.forEach((doc) => {
                            this.members.push({ uid: doc.id, ...doc.data() });
                        });
                    } catch (error) {
                        this.showNotification('Erro ao buscar membros.', 'error');
                        console.error("Error fetching members: ", error);
                    }
                },
                async addMember() {
                    // Simula a criação adicionando no Firestore para controle.
                    // A senha NÃO é salva por segurança. O aluno deve se cadastrar.
                    try {
                        const userRef = doc(db, 'users', this.memberForm.email);
                        await setDoc(userRef, { email: this.memberForm.email, role: 'student' });
                        this.showNotification('Membro adicionado! O aluno precisa se cadastrar com este email.', 'success');
                        this.closeMemberModal();
                        this.fetchMembers();
                    } catch (error) {
                         this.showNotification(`Erro ao adicionar membro: ${error.message}`, 'error');
                    }
                },
                closeMemberModal() {
                    this.showAddMemberModal = false;
                    this.showEditMemberModal = false;
                    this.isEditingMember = false;
                    this.memberForm = { email: '', password: '', uid: null };
                },
                prepareEditMember(member) {
                    this.isEditingMember = true;
                    Object.assign(this.memberForm, { email: member.email, uid: member.uid, password: '' });
                    this.showEditMemberModal = true;
                },
                async updateMember() {
                    this.showNotification('Funcionalidade de edição (email/senha) requer backend.', 'success');
                    this.closeMemberModal();
                },
                prepareRemoveMember(member) {
                    this.memberToRemove = member;
                    this.showRemoveMemberModal = true;
                },
                async removeMember() {
                     try {
                        await deleteDoc(doc(db, "users", this.memberToRemove.uid));
                        this.showNotification('Membro removido com sucesso!', 'success');
                        this.showRemoveMemberModal = false;
                        this.memberToRemove = null;
                        this.fetchMembers();
                    } catch(error) {
                        this.showNotification(`Erro ao remover membro: ${error.message}`, 'error');
                    }
                },
                // === MÉTODOS DE ADMIN - NOTAS ===
                async fetchGrades() {
                    if (!this.grades.selectedBimestre || !this.grades.selectedMateria) return;
                    this.grades.isLoading = true;
                    
                    // 1. Reinicia a planilha com todos os membros
                    let newSheet = {};
                    this.members.forEach(member => {
                        newSheet[member.uid] = { l1: '', l2: '', l3: '', l4: '', docId: null };
                    });

                    // 2. Busca as notas existentes no Firestore
                    const gradesCollection = collection(db, 'grades');
                    const q = query(gradesCollection, 
                        where('bimestre', '==', this.grades.selectedBimestre),
                        where('materia', '==', this.grades.selectedMateria)
                    );
                    const querySnapshot = await getDocs(q);

                    // 3. Preenche a planilha com as notas encontradas
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        if(newSheet[data.studentUid]) {
                            newSheet[data.studentUid] = {
                                l1: data.l1 || '',
                                l2: data.l2 || '',
                                l3: data.l3 || '',
                                l4: data.l4 || '',
                                docId: doc.id
                            };
                        }
                    });

                    this.grades.sheet = newSheet;
                    this.grades.isLoading = false;
                },
                calculateAverage(studentUid) {
                    const studentGrades = this.grades.sheet[studentUid];
                    if (!studentGrades) return 'N/A';
                    
                    const notes = [studentGrades.l1, studentGrades.l2, studentGrades.l3, studentGrades.l4]
                        .map(n => parseFloat(n))
                        .filter(n => !isNaN(n) && n >= 0);

                    if (notes.length === 0) return 'N/A';
                    
                    const sum = notes.reduce((acc, curr) => acc + curr, 0);
                    const average = sum / notes.length;
                    return average.toFixed(1);
                },
                async saveGrades() {
                    try {
                        const batch = writeBatch(db);
                        for (const studentUid in this.grades.sheet) {
                            const gradeData = this.grades.sheet[studentUid];
                            const student = this.members.find(m => m.uid === studentUid);
                            
                            const dataToSave = {
                                studentUid: studentUid,
                                studentEmail: student.email,
                                bimestre: this.grades.selectedBimestre,
                                materia: this.grades.selectedMateria,
                                l1: gradeData.l1 === '' ? null : Number(gradeData.l1),
                                l2: gradeData.l2 === '' ? null : Number(gradeData.l2),
                                l3: gradeData.l3 === '' ? null : Number(gradeData.l3),
                                l4: gradeData.l4 === '' ? null : Number(gradeData.l4),
                            };

                            if (gradeData.docId) {
                                // Atualiza documento existente
                                const docRef = doc(db, 'grades', gradeData.docId);
                                batch.set(docRef, dataToSave, { merge: true });
                            } else {
                                // Cria novo documento
                                const docRef = doc(collection(db, 'grades'));
                                batch.set(docRef, dataToSave);
                            }
                        }
                        await batch.commit();
                        this.showNotification('Notas salvas com sucesso!', 'success');
                        this.fetchGrades(); // Recarrega para obter os docIds
                    } catch (error) {
                        console.error("Erro ao salvar notas: ", error);
                        this.showNotification('Erro ao salvar as notas.', 'error');
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>


